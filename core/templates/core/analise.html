{% extends 'core/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<style>
    /* Cards Coloridos */
    .kpi-card {
        background: white;
        border-left: 5px solid #0d6efd;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        height: 100%;
        transition: transform 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
    }

    .kpi-title {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .kpi-value {
        font-size: 1.3rem;
        font-weight: 800;
        color: #212529;
        white-space: nowrap;
    }

    /* Tabelas e Filtros */
    .filter-label {
        font-size: 0.75rem;
        font-weight: bold;
        color: #666;
        margin-bottom: 2px;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .ts-control {
        min-height: 31px;
        font-size: 0.8rem;
        padding: 2px 8px;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>ðŸ”Ž AnÃ¡lise Detalhada</h3>
</div>

<div class="card p-3 mb-4 border-0 shadow-sm bg-light">
    <form method="get" action="{% url 'analise' %}">
        <div class="row g-2 mb-2">
            <div class="col-md-1">
                <label class="filter-label">Ano</label>
                <select name="ano" multiple placeholder="Ano">
                    {% for x in opts.ano %}
                    <option value="{{ x }}" {% if x|stringformat:"s" in sel.ano %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-1">
                <label class="filter-label">MÃªs</label>
                <select name="mes" multiple placeholder="MÃªs">
                    {% for x in opts.mes %}
                    <option value="{{ x }}" {% if x|stringformat:"s" in sel.mes %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-1">
                <label class="filter-label">Dia</label>
                <select name="dia" multiple placeholder="Dia">
                    {% for x in opts.dia %}
                    <option value="{{ x }}" {% if x|stringformat:"s" in sel.dia %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="filter-label">Filial (Origem)</label>
                <select name="filial" multiple placeholder="Selecione...">
                    {% for x in opts.filial %}
                    <option value="{{ x }}" {% if x in sel.filial %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="filter-label">Cliente (Destino)</label>
                <select name="cliente" multiple placeholder="Selecione...">
                    {% for x in opts.cliente %}
                    <option value="{{ x }}" {% if x in sel.cliente %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="filter-label">Transp.</label>
                <select name="transp" multiple placeholder="Selecione...">
                    {% for x in opts.transp %}
                    <option value="{{ x }}" {% if x in sel.transp %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-1">
                <label class="filter-label">Modo</label>
                <select name="mod_frete" multiple placeholder="Tipo">
                    {% for x in opts.mod %}
                    <option value="{{ x }}" {% if x in sel.mod %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="filter-label">OperaÃ§Ã£o</label>
                <select name="tipo_op" multiple placeholder="OperaÃ§Ã£o">
                    {% for x in opts.tipo %}
                    <option value="{{ x }}" {% if x in sel.tipo %}selected{% endif %}>{{ x }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row g-2 align-items-end">
            <div class="col-md-2">
                <label class="filter-label">NF-e (Busca)</label>
                <input type="text" name="numero_nf" class="form-control form-control-sm" value="{{ sel.val_nf }}"
                    placeholder="Digite...">
            </div>
            <div class="col-md-2">
                <label class="filter-label">CT-e (Busca)</label>
                <input type="text" name="numero_cte" class="form-control form-control-sm" value="{{ sel.val_cte }}"
                    placeholder="Digite...">
            </div>
            <div class="col-md-8 d-flex justify-content-end gap-2">
                <a href="{% url 'analise' %}" class="btn btn-outline-secondary btn-sm">Limpar</a>
                <button type="submit" class="btn btn-primary btn-sm px-4">Aplicar</button>
            </div>
        </div>
    </form>
</div>

{% if no_data %}
<div class="alert alert-info text-center">Nenhum dado encontrado.</div>
{% else %}

<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="kpi-card">
            <div class="kpi-title">Custo NFs</div>
            <div class="kpi-value text-primary">{{ kpis.total_nf }}</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="kpi-card" style="border-left-color: #198754;">
            <div class="kpi-title">Peso Bruto</div>
            <div class="kpi-value text-success">{{ kpis.peso_total }}</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="kpi-card" style="border-left-color: #dc3545;">
            <div class="kpi-title">Valor Frete</div>
            <div class="kpi-value text-danger">{{ kpis.frete_total }}</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="kpi-card" style="border-left-color: #fd7e14;">
            <div class="kpi-title">PedÃ¡gio</div>
            <div class="kpi-value" style="color: #fd7e14;">{{ kpis.pedagio_total }}</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="kpi-card" style="border-left-color: #6610f2;">
            <div class="kpi-title">% Frete/NF</div>
            <div class="kpi-value" style="color: #6610f2;">{{ kpis.perc_frete }}</div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="kpi-card" style="border-left-color: #ffc107;">
            <div class="kpi-title">Viagens</div>
            <div class="kpi-value text-warning">{{ kpis.viagens }}</div>
        </div>
    </div>
</div>

{% if detalhes.numero_nf %}
<div class="card mb-4 border-primary shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>ðŸ“¦ Itens da Nota: <strong>{{ detalhes.numero_nf }}</strong></span>
        <button onclick="closeDetails()" class="btn btn-sm btn-light py-0">Fechar</button>
    </div>
    <div class="card-body p-0">
        {% if detalhes.msg %}
        <div class="alert alert-warning m-3">{{ detalhes.msg }}</div>
        {% else %}
        <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Item</th>
                        <th>Produto</th>
                        <th>NCM</th>
                        <th>CFOP</th>
                        <th>Qtd</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in detalhes.itens %}
                    <tr>
                        <td>{{ i.item_num }}</td>
                        <td>{{ i.produto }}</td>
                        <td>{{ i.ncm }}</td>
                        <td>{{ i.cfop }}</td>
                        <td>{{ i.qtd_fmt }}</td>
                        <td>{{ i.vl_total_fmt }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table id="mainTable" class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
            <thead class="table-light">
                <tr>
                    <th>Data</th>
                    <th>CT-e</th>
                    <th>CT-e Comp.</th>
                    <th>NF-e</th>
                    <th>Origem</th>
                    <th>Destino</th>
                    <th>Cliente</th>
                    <th class="text-end">Valor NF</th>
                    <th class="text-end">Peso NF</th>
                    <th class="text-end">Peso CTE</th>
                    <th class="text-end">Frete Rateado</th>
                    <th>Tipo Frete</th>
                    <th>OperaÃ§Ã£o</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in docs %}
                <tr onclick="selectNF('{{ doc.chave_nf }}')" style="cursor: pointer;" title="Clique para ver os itens">
                    <td>{{ doc.data|date:"d/m/Y" }}</td>
                    <td>{{ doc.numero_cte|default:"-" }}</td>
                    <td>{{ doc.cte_complementar|default:"-" }}</td>
                    <td class="fw-bold text-primary">{{ doc.numero_nf }}</td>
                    <td>{{ doc.cidade_origem }}</td>
                    <td>{{ doc.cidade_destino }}</td>
                    <td title="{{ doc.destinatario }}">{{ doc.Destinatario_Legivel|truncatechars:20 }}</td>
                    <td class="text-end">{{ doc.valor_nf_fmt }}</td>
                    <td class="text-end">{{ doc.peso_fmt }}</td>
                    <td class="text-end">{{ doc.peso_cte_fmt }}</td>
                    <td class="text-end fw-bold">{{ doc.frete_fmt }}</td>
                    <td>{{ doc.Frete_Tipo }}</td>
                    <td>{{ doc.Operacao }}</td>
                </tr>
                {% empty %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
    $(document).ready(function () {
        $('#mainTable').DataTable({
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
            "pageLength": 25,
            "order": [[0, "desc"]]
        });
    });

    function updateQueryString(key, value) {
        const url = new URL(window.location.href);
        if (value) { url.searchParams.set(key, value); } else { url.searchParams.delete(key); }
        window.location.href = url.toString();
    }
    function selectNF(chave) { updateQueryString('selected_nf', chave); }
    function closeDetails() { updateQueryString('selected_nf', null); }

    document.querySelectorAll('select').forEach((el) => {
        new TomSelect(el, { plugins: ['remove_button'], maxOptions: 50, hideSelected: true, closeAfterSelect: false });
    });
</script>
{% endblock %}